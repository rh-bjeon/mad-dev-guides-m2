= 3. Kubernetes에 배포 - 10분
:imagesdir: ../assets/images

== 이 랩의 목표

이 실습의 목표는 link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.11/html-single/cicd/index#builds-binary-source_creating-build-inputs[OpenShift Binary Build and Deployment^]를 사용하여 현대화된 고객 애플리케이션을 빌드하고 OpenShift에 배포하는 것입니다.

다음과 같은 내용을 진행합니다:
* Apache Tomcat 대신 Red Hat JBoss 웹 서버를 런타임으로 사용하여 새롭고 현대화된 애플리케이션을 빌드하고 배포하려면 OpenShift 바이너리 빌드 전략을 사용합니다.
* 새로운 *customers* 서비스 테스트

== 3.1. 새 프로젝트 만들기

[IMPORTANT]
====
아직 OpenShift 클러스터에 로그인하지 않은 경우 VS Code 서버 터미널에서 다음 `oc` 명령을 실행하세요.

[.console-input]
[source,bash]
----
oc login -u %USERID% -p openshift https://openshift.default.svc:443
----
====

OpenShift 클러스터에서 새 프로젝트를 만들어 새롭게 현대화된 애플리케이션인 *customers* 를 배포합니다. 터미널에서 다음 명령을 실행합니다.

[.console-input]
[source,bash,subs="+attributes,macros+"]
----
oc new-project customers-qa-%USERID%
----

== 3.2. 디렉토리 구조 준비

로컬 파일 시스템과 `deployments/` 하위 디렉토리에 바이너리 빌드를 위한 디렉토리를 만듭니다. 터미널에서 다음 명령을 실행하여 WAR 아카이브를 `deployments/` 디렉토리로 복사합니다.

[.console-input]
[source,bash,subs="+attributes,macros+"]
----
cd $HOME/modern-app-dev/customers-tomcat-legacy

mkdir -p ocp/deployments

cp target/customers-tomcat-0.0.1-SNAPSHOT.war ocp/deployments/
----

== 3.3. 애플리케이션 컨테이너 이미지 빌드

이미지 스트림과 애플리케이션 이름을 지정하여 새 빌드 구성을 만듭니다. 이를 위해 터미널에서 다음 명령을 실행합니다.

[.console-input]
[source,bash,subs="+attributes,macros+"]
----
oc new-build --binary=true \
 --image-stream=jboss-webserver57-openjdk11-tomcat9-openshift-ubi8:latest \
 --name=customers
----

출력 결과는 다음과 같습니다.

[.console-output]
[source,bash,subs="+attributes,macros+"]
----
--> Found image de5b7ae (5 weeks old) in image stream "openshift/jboss-webserver57-openjdk11-tomcat9-openshift-ubi8" under tag "latest" for "jboss-webserver57-openjdk11-tomcat9-openshift-ubi8:latest"

    JBoss Web Server 5.7 OpenJDK11 
    ------------------------------ 
    Platform for building and running web applications on JBoss Web Server 5.7 with OpenJDK11 - Tomcat v9

    Tags: builder, java, tomcat9

    * A source build using binary input will be created
      * The resulting image will be pushed to image stream tag "customers:latest"
      * A binary build was created, use 'oc start-build --from-dir' to trigger a new build

--> Creating resources with label build=customers ...
    imagestream.image.openshift.io "customers" created
    buildconfig.build.openshift.io "customers" created
--> Success
----

== 3.4. 바이너리 빌드 시작

방금 만든 빌드 구성을 기반으로 바이너리 빌드를 시작합니다. OpenShift에 이미지 빌드의 바이너리 입력을 위해 만든 `ocp` 디렉토리를 사용하도록 지시합니다.

빌드를 시작하려면 터미널에서 다음 명령을 실행하세요.

[.console-input]
[source,bash,subs="+attributes,macros+"]
----
oc start-build customers --from-dir=./ocp --follow
----

출력은 다음과 같아야 합니다.

[.console-output]
[source,bash,subs="+attributes,macros+"]
----
....
Pushing image image-registry.openshift-image-registry.svc:5000/customers-qa--%USERID%/customers:latest ...
Getting image source signatures
Copying blob sha256:1b890c73c3cf60b04334fded9e3edc647d64dd39ffd078317e2bd69552a2fd1d
Copying blob sha256:de63ba066b7c0c23e2434efebcda7800d50d60f33803af9c500f75a69fb76ffa
Copying blob sha256:04cfcc380bdf1d3454fa799d09adb1a7c56bdb66e42e90bd27504dda9c36470f
Copying blob sha256:e2eaf64b098803173d3114593a4936dbce963608a9529b31927864cad0dc8b57
Copying blob sha256:ad1cc61bdc476723b61f5cca7be1806ab9b7076d5a1fd682024f32c02bac1102
Copying config sha256:10491aca30dd9d7eda9d862f0609029e1168e5b1807073cd26169e899ea14ee7
Writing manifest to image destination
Storing signatures
Successfully pushed image-registry.openshift-image-registry.svc:5000/customers-qa-%USERID%/customers@sha256:8c3bced59a26db5d53afabe4990350444ceee1ca66eca78f10b7d4b5c61d2aaf
Push successful
----

== 3.5. 새로운 OpenShift 애플리케이션 생성

새로 빌드된 컨테이너 이미지를 기반으로 새로운 OpenShift 애플리케이션을 만듭니다. 터미널에서 다음 명령을 실행합니다.

[.console-input]
[source,bash,subs="+attributes,macros+"]
----
oc new-app customers
----

출력 결과는 다음과 같습니다.

[.console-output]
[source,bash,subs="+attributes,macros+"]
----
--> Found image 50f873a (15 seconds old) in image stream "customers-qa-user1/customers" under tag "latest" for "customers"

    JBoss Web Server 5.7 OpenJDK11 
    ------------------------------ 
    Platform for building and running web applications on JBoss Web Server 5.7 with OpenJDK11 - Tomcat v9

    Tags: builder, java, tomcat9


--> Creating resources ...
    deployment.apps "customers" created
    service "customers" created
--> Success
    Application is not exposed. You can expose services to the outside world by executing one or more of the commands below:
     'oc expose service/customers' 
    Run 'oc status' to view your app.
----

다음 레이블을 추가하여 JBoss 웹 서버에서 실행 중인 애플리케이션을 표시할 수 있습니다. 터미널에서 다음 명령을 실행합니다.

[.console-input]
[source,bash,subs="+attributes,macros+"]
----
oc label deployment/customers app.openshift.io/runtime=rh-tomcat
----

== 3.6. 신규 customers 애플리케이션 확인

축하합니다! OpenShift 클러스터에 새로운 *customers* 애플리케이션을 성공적으로 배포했습니다.

* 애플리케이션이 customers-qa-%USERID% 프로젝트에서 실행 중인 경우 link:https://console-openshift-console.%SUBDOMAIN%/topology/ns/customers-qa-%USERID%?view=graph[토폴로지 뷰^]에 액세스합니다.

이전에 OpenShift 클러스터에 로그인한 적이 없다면 다음 자격증명을 사용하세요. OpenShift는 이미 https://access.redhat.com/products/red-hat-single-sign-on/[Red Hat Single Sign On^]과 통합되어 있습니다.

image::sso_login.png[openshift_login]

* 자격증명을 사용하여 로그인하세요:

** 사용자 이름: `%USERID%`
** 비밀번호: `{openshift-password}`

image::customers-qa-topology.png[고객-qa-토폴로지]

OpenShift 가상화의 새 PostgreSQL 데이터베이스에서 고객 데이터를 검색하려면 고객 애플리케이션의 다음 RESTful API에 액세스하세요.

[.console-input]
[source,bash]
----
curl http://customers.customers-qa-%USERID%.svc.cluster.local:8080/customers-tomcat-0.0.1-SNAPSHOT/customers/1 ; echo
----

출력 결과는 다음과 같습니다.

[.console-output]
[source,bash,subs="+attributes,macros+"]
----
{"id":1,"username":"phlegm_master_19","name":"Guybrush","surname":"Threepwood","address":"1060 West Addison","zipCode":"ME-001","city":"Melee Town","country":"Melee Island"}
----

이는 OpenShift에서 실행되는 새롭게 현대화된 애플리케이션이 백엔드 데이터베이스에서 고객 데이터를 성공적으로 검색할 수 있음을 보여줍니다.

== 요약

축하합니다! 이제 발견한 모든 마이그레이션 문제를 성공적으로 해결하고 레거시 애플리케이션을 리팩토링했습니다. 다음 모듈에서는 Red Hat OpenShift 클러스터에서 고급 애플리케이션 관리를 위해 `CI/CD` 및 `GitOps` 를 구현하는 방법을 알아봅니다.